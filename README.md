## websocket-mvc-springboot-starter

&emsp;`websocket-mvc-springboot-starter`æ˜¯ä¸€æ¬¾åŸºäºSpringBootå¼€å‘çš„websocketæ¡†æ¶ï¼Œspringbootå®˜æ–¹æä¾›çš„websocketæ¡†æ¶è™½ç„¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ­å»ºä¸€ä¸ªwebsocketæœåŠ¡ï¼›ä½†æ˜¯å¯¹äºæŒç»­äº¤äº’é€šä¿¡è€Œè¨€ï¼Œä¾¿æ·çš„é€šä¿¡æ–¹å¼æ‰èƒ½è®©å¼€å‘è€…æ›´å¥½çš„å…³æ³¨ä¸šåŠ¡æµç¨‹ï¼›æœ¬æ¡†æ¶æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºï¼Œè§„èŒƒé€šä¿¡å†…å®¹ï¼Œä»¥urlå­—æ®µæ˜ å°„åˆ°å¯¹åº”çš„å¤„ç†å™¨ï¼ŒæŠŠå®¢æˆ·ç«¯çš„æ¶ˆæ¯ç›´æ¥äº¤ç»™å¯¹åº”urlçš„å¤„ç†å™¨è¿›è¡Œå¤„ç†å³å¯ï¼Œè¿™å’ŒspringMVCå¦‚å‡ºä¸€è¾™ï¼›åŒæ—¶å¯¹äºå‘é€ç»™å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡JSåŠ¨æ€å‡½æ•°è°ƒç”¨å»å¤„ç†ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå¼€å‘è€…ä¸éœ€è¦ä½¿ç”¨å¤§é‡çš„if-elseå»å¤„ç†ä¸åŒçš„æ¶ˆæ¯ç±»å‹ã€‚åªéœ€è¦å¼€å‘å…·ä½“çš„å¤„ç†é€»è¾‘å³å¯ï¼Œå½“ç„¶è¿™åªæ˜¯æœ¬æ¡†æ¶æœ€å¤§çš„ç‰¹åˆ«ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æä¾›æ‹¦æˆªå™¨å’Œç™»å½•æ ¡éªŒå¤„ç†å™¨ç­‰ç­‰ä¾¿æ·çš„åŠŸèƒ½ã€‚

<br>

&emsp;**`websocket-mvc-springboot-starter`å®ç°äº†ç±»ä¼¼`spring-mvc`æ¡†æ¶ç±»ä¼¼çš„æ–¹æ³•æ˜ å°„ï¼Œå¹¶ä¸”æ”¯æŒäº†è¯¸å¤šåŠŸèƒ½å¢å¼ºï¼Œæå¤§ç®€åŒ–å’Œæé«˜äº¤äº’ï¼Œç®€åŒ–æ¶ˆæ¯å¤„ç†é€»è¾‘**ã€‚

<br>

&emsp;ğŸš€é¡¹ç›®ä¼šæŒç»­ä¼˜åŒ–è¿­ä»£ï¼Œæ¬¢è¿å¤§å®¶æISSUEï¼éº»çƒ¦å¤§å®¶èƒ½ç»™ä¸€é¢—starï¼Œæ‚¨çš„staræ˜¯æˆ‘ä»¬æŒç»­æ›´æ–°çš„åŠ¨åŠ›ï¼Œæ„Ÿè°¢ï¼

<br>

&emsp;Githubé¡¹ç›®åœ°å€ï¼š[https://github.com/TomHusky/websocket-mvc-springboot-starter](https://github.com/TomHusky/websocket-mvc-springboot-starter)

&emsp;ç¤ºä¾‹demoï¼š[http://github.com/TomHusky/websocket-mvc-springboot-starter-demo](http://github.com/TomHusky/websocket-mvc-springboot-starter-demo)

## åŠŸèƒ½ç‰¹æ€§

- [1] [å®šä¹‰æ§åˆ¶å™¨æ¥å£](#å®šä¹‰æ§åˆ¶å™¨æ¥å£)
- [2] [æ¶ˆæ¯æ¥æ”¶æ ¼å¼å’Œå‘é€æ ¼å¼](#æ¶ˆæ¯æ¥æ”¶æ ¼å¼å’Œå‘é€æ ¼å¼)
- [3] [æ‹¦æˆªå™¨](#æ‹¦æˆªå™¨)
- [4] [å‚æ•°æ³¨å…¥å’Œå‚æ•°æ ¡éªŒ](#å‚æ•°æ³¨å…¥å’Œå‚æ•°æ ¡éªŒ)
- [5] [æœåŠ¡ç«¯ä¸»åŠ¨ä¸‹å‘æ¶ˆæ¯](#æœåŠ¡ç«¯ä¸»åŠ¨ä¸‹å‘æ¶ˆæ¯)
  <br>

## å¿«é€Ÿä½¿ç”¨

### å¼•å…¥ä¾èµ–
**å»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼ŒåŠŸèƒ½æœ€å…¨ï¼Œbugæœ€å°‘**

```xml
<dependency>
    <groupId>io.github.tomhusky</groupId>
   <artifactId>websocket-mvc-springboot-starter</artifactId>
   <version>1.0.3</version>
</dependency>
```
<br>

### å®šä¹‰æ§åˆ¶å™¨æ¥å£

&emsp;æ§åˆ¶å™¨æ¥å£å¿…é¡»ä½¿ç”¨`@SocketController` æ³¨è§£,è¿™æ ·æ‰èƒ½è¢«æ‰«æåˆ°ï¼Œå¦åˆ™æ§åˆ¶å™¨æ— æ³•ä½¿ç”¨

`@SocketRequestMapping`æ³¨è§£åœ¨ç±»ä¸Šæ—¶ï¼Œvalueå¯ä»¥ä¸å¡«ï¼Œæ³¨è§£åœ¨æ–¹æ³•ä¸Šæ—¶å¿…å¡«ï¼Œå¦åˆ™æ— æ³•æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ï¼Œç±»ä¼¼äºspringmvcï¼›

ä¸‹é¢æŒ‰ç†é‡Œé¢æ§åˆ¶å™¨å¯¹åº”çš„è·¯å¾„ä¸º /test/getValue

```java
@SocketController
@SocketRequestMapping("/test")
public class TestController {
    
    @SocketRequestMapping("/getValue")
    public JsonResult<String> getValue() {

        return JsonResult.success("ok");
    }
}
```


### é…ç½®æ‰«æåŒ…
```yaml
web-socket-mvc:
  basePackage: io.github.tomhusky.test.controller
```
é…ç½®æ§åˆ¶å™¨æ‰€åœ¨çš„åŒ…è·¯å¾„ï¼Œåˆ™åœ¨io.github.tomhusky.test.controlleræ‰€æœ‰æ³¨è§£äº†`@SocketRequestMapping`çš„æ§åˆ¶å™¨éƒ½è¢«æ‰«æåˆ°ã€‚

### æ¶ˆæ¯æ¥æ”¶æ ¼å¼å’Œå‘é€æ ¼å¼
>æ¡†æ¶ä¸¥æ ¼æ§åˆ¶æ¶ˆæ¯ä¼ é€’çš„å†…å®¹ï¼Œå¦‚æœæ ¼å¼ä¸å¯¹ï¼Œå†…å®¹å°†æ— æ³•æ­£ç¡®çš„ä¼ è¾“ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜¯å¿…é¡»çš„ï¼

å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯çš„å†…å®¹æ ¼å¼ï¼ˆæœåŠ¡ç«¯æ¥æ”¶æ¶ˆæ¯æ ¼å¼ï¼‰

```json
{
    "url":"/test/getValue",
    "body":"hello"
}
```
- url&emsp;&emsp;&nbsp;æ§åˆ¶å™¨çš„åœ°å€ï¼Œç”¨äºæ˜ å°„ã€‚
- body&emsp;æ¶ˆæ¯å†…å®¹ï¼Œå¯ä»¥ä¸ºä»»æ„å­—ç¬¦ä¸²ï¼Œæ¨èä½¿ç”¨json

<br>
æœåŠ¡ç«¯æ¶ˆæ¯å‘é€å†…å®¹æ ¼å¼ï¼ˆå®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯æ ¼å¼ï¼‰

```json
{
  "status": 200,
  "type": 1,
  "errorMsg": "",
  "url": "/test/getValue",
  "body": "hello world"
}
```
- status&emsp;&emsp;&nbsp;&nbsp;çŠ¶æ€ï¼› 200 æˆåŠŸ ï¼Œ 500å¤±è´¥ ï¼›ä»…åœ¨typeä¸º1æ—¶æœ‰æ•ˆ
- type&emsp;&emsp;&emsp;&nbsp;å“åº”ç±»å‹ï¼›1 å®¢æˆ·ç«¯è¯·æ±‚è¿”å› ï¼Œ 2 æœåŠ¡ç«¯ä¸»åŠ¨è¿”å›
- errorMsg&emsp;é”™è¯¯åŸå› ï¼› ä»…åœ¨statusä¸æ˜¯200æ—¶æœ‰æ•ˆ
- url&emsp;&emsp;&emsp;&emsp;&nbsp;æ¶ˆæ¯å¯¹åº”çš„åœ°å€ï¼›åŒæ¶ˆæ¯æ¥æ”¶ä¸€è‡´
- body&emsp;&emsp;&emsp;æ¶ˆæ¯å†…å®¹ï¼›åŒæ¶ˆæ¯æ¥æ”¶ä¸€è‡´

<br>

### æ‹¦æˆªå™¨

#### å›è¯æ‹¦æˆªå™¨

é€šè¿‡å®ç°`CustomerWebSocketHandler`æ¥å£ï¼ŒæœåŠ¡ç«¯å¯ä»¥å®ç°å®¢æˆ·ç«¯è¿æ¥å’Œæ¶ˆæ¯æ‹¦æˆªï¼Œæ ¹æ®ä¸åŒæ˜¯å›è°ƒè¿›è¡Œç›¸åº”çš„ä¸šåŠ¡å¤„ç†ï¼Œæ¯”å¦‚è¿æ¥æˆåŠŸä¹‹åä¿å­˜ç”¨æˆ·å¯¹åº”çš„å›è¯ï¼›ï¼ˆæ³¨æ„ï¼Œå®ç°æ¥å£çš„ç±»å¿…é¡»æ³¨å…¥åˆ°springå®¹å™¨é‡Œé¢ï¼Œå¦åˆ™ä¸èµ·ä½œç”¨ï¼‰
```java
public interface CustomerWebSocketHandler {

    /**
     * ä¸” WebSocket è¿æ¥å·²æ‰“å¼€å¹¶å¯ä¾›ä½¿ç”¨åè°ƒç”¨ã€‚
     *
     * @param webSocketSession ä¼šè¯å¯¹è±¡
     */
    void afterConnectionEstablished(WebSocketSession webSocketSession);

    /**
     * æ¶ˆæ¯åˆ°è¾¾æ—¶è°ƒç”¨
     *
     * @param webSocketSession ä¼šè¯å¯¹è±¡
     * @param message          æ¶ˆæ¯å†…å®¹
     */
    void handleMessage(WebSocketSession webSocketSession, TextMessage message);

    /**
     * åœ¨ WebSocket è¿æ¥è¢«ä»»ä¸€æ–¹å…³é—­åæˆ–å‘ç”Ÿä¼ è¾“é”™è¯¯åè°ƒç”¨ã€‚
     *
     * @param webSocketSession ä¼šè¯å¯¹è±¡
     * @param status           çŠ¶æ€ç 
     */
    void afterConnectionClosed(WebSocketSession webSocketSession, CloseStatus status);
}
```

å®ç°æ¥å£ï¼ŒåŠ ä¸Š@Componentæ³¨è§£

```java

@Slf4j
@Component
public class WebSocketMsgHandler implements CustomerWebSocketHandler {

    @Override
    public void afterConnectionEstablished(WebSocketSession webSocketSession) {
        log.info("------------è¿æ¥æˆåŠŸ:{}-------------", webSocketSession.getId());
    }

    @Override
    public void handleMessage(WebSocketSession webSocketSession, TextMessage textMessage) {
        log.info("------------æ”¶åˆ°æ¶ˆæ¯:{}-------------", webSocketSession.getId());
        log.info(textMessage.getPayload());
    }

    @Override
    public void afterConnectionClosed(WebSocketSession webSocketSession, CloseStatus closeStatus) {
        log.info("------------è¿æ¥å…³é—­{}-------------", webSocketSession.getId());
    }
}
```

#### ç™»å½•æ‹¦æˆªå™¨

springbooté»˜è®¤çš„è¿æ¥æ˜¯ä¸æä¾›ç™»å½•æ ¡éªŒçš„ï¼Œä¸è¿‡ä½ ä¹Ÿå¾—å¼€æ”¾socketæ¥å£ï¼›ä¸ºäº†æ–¹ä¾¿å¼€æ”¾äººå‘˜ï¼Œæ¡†æ¶å®ç°äº†JWTæ–¹å¼çš„ç™»å½•æ ¡éªŒæ‹¦æˆªå™¨ï¼Œå®¢æˆ·ç«¯åªéœ€è¦åœ¨è¿æ¥çš„æ—¶å€™ï¼ŒåŠ å…¥tokenï¼Œæ‹¦æˆªå™¨åˆ™ä¼šæŠŠtokenæ³¨å…¥åˆ°è¯·æ±‚å¤´çš„ `Authorization` å­—æ®µï¼Œè¿™ä¸ªå­—æ®µåå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼›åœ¨æ‹¦æˆªå™¨é‡Œé¢è·å–tokenä¹‹åè¿›è¡Œé€»è¾‘æ ¡éªŒ;

- ç»§æ‰¿LoginValidInterceptæ¥å£ï¼ŒåŠ å…¥@Componentæ³¨è§£,attemptAuthenticationæ˜¯åœ¨æ¡æ‰‹ä¹‹å‰è¢«è°ƒç”¨çš„ï¼Œè¿”å›trueåˆ™å…è®¸å®¢æˆ·ç«¯è¿æ¥è¿”å›falseåˆ™æ‹’ç»è¿æ¥ã€‚ successfulAuthenticationæ–¹æ³•åœ¨é€šè¿‡å®¢æˆ·ç«¯è¿æ¥å¹¶ä¸”æ¡æ‰‹æˆåŠŸä¹‹åè¢«è°ƒç”¨ï¼›

- æ³¨æ„ LoginValidInterceptç±»åªèƒ½è¢«ä¸€ä¸ªç±»åŸºç¡€ï¼Œå¤šä¸ªspringä¼šæŠ¥æ•°é‡å¼‚å¸¸ï¼Œè¿”å›ä¸æ­¢ä¸€ä¸ªå­ç±»ï¼›

```java
@Slf4j
@Component
public class TokenValidIntercept extends LoginValidIntercept {

    public static final String TOKEN_HEAD = "Authorization";

    @Override
    public boolean attemptAuthentication(ServerHttpRequest request, ServerHttpResponse response) {
        String token = request.getHeaders().getFirst(TOKEN_HEAD);
        if (token == null || CharSequenceUtil.isBlank(token)) {
            return false;
        }
        // è¿›è¡Œé€»è¾‘åˆ¤æ–­
        return true;
    }

    @Override
    public void successfulAuthentication(ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse) {
        log.info("æ¡æ‰‹æˆåŠŸ");
    }
}

```
<br>

### å‚æ•°æ³¨å…¥å’Œå‚æ•°æ ¡éªŒ
#### å‚æ•°æ³¨å…¥
ç›®å‰åªæ”¯æŒå•ä¸€å‚æ•°åŠ ä¸€ä¸ªWebSocketSessionå›è¯å¯¹è±¡çš„æ³¨å…¥ï¼Œå•ä¸ªå‚æ•°æ”¯æŒStringï¼ŒIntegerç­‰åŸºæœ¬æ•°æ®ç±»å‹å’Œå®ƒä»¬çš„åŒ…è£…ç±»ã€‚å¯¹è±¡å‚æ•°ä½¿ç”¨jsonå½¢å¼è¿›è¡Œæ„å»ºã€‚

å•ä¸ªå‚æ•°å½¢å¼
```java
 @SocketRequestMapping("/getValue")
 public JsonResult<String> getValue(String name) {
     System.out.println(name);
     return JsonResult.success("ok");
 }

å¯¹åº”çš„å®¢æˆ·ç«¯æ¶ˆæ¯æ ¼å¼ä¸ºï¼š
{
    "url":"test/getValue",
    "body":"æµ‹è¯•"
}
```

å¯¹è±¡æ³¨å…¥å’Œå›è¯å¯¹è±¡æ³¨å…¥
```java
 @SocketRequestMapping("/getInfo")
 public JsonResult<String> getValue(TestVo testVo, WebSocketSession webSocketSession) {
     System.out.println(testVo);
     return JsonResult.success("ok");
 }

å¯¹åº”çš„å®¢æˆ·ç«¯æ¶ˆæ¯ä¸º

{
    "url":"test/getInfo",
    "body":{
        "name":"ttt",
        "age":18
    }
}
```

#### å‚æ•°æ ¡éªŒ

å‚æ•°æ ¡éªŒæ¥å…¥springçš„`validation`æ¡†æ¶ï¼Œä½¿ç”¨å’ŒspringMvcæˆ–è€…springbootä¸€è‡´å³å¯ã€‚

```java
@SocketRequestMapping("/getInfo2")
public JsonResult<String> getInfo2(@Valid TestVo testVo, WebSocketSession webSocketSession) {
    System.out.println(testVo);
    return JsonResult.success("ok");
}


@Data
public class TestVo {
	
    @NotBlank(message = "nameä¸èƒ½ä¸ºç©º")
    private String name;

    @NotNull(message = "ageä¸èƒ½ä¸ºç©º")
    private Integer age;

    private String msg;
	
}

å‰ç«¯å‘é€æ¶ˆæ¯æ ¼å¼

{
    "url":"test/getInfo2",
    "body":{
        "name":"ttt",
        "age":18
    }
}

```

### æœåŠ¡ç«¯ä¸»åŠ¨ä¸‹å‘æ¶ˆæ¯

æ¡†æ¶æä¾›`SocketSessionManager` å·¥å…·ç±»ç”¨äºä¸»åŠ¨ä¸‹å‘æ¶ˆæ¯ï¼Œä¸è¿‡éœ€è¦å¼€å‘è€…ä¿å­˜å®¢æˆ·ç«¯å¯¹åº”çš„å›è¯idï¼Œè¿™æ ·æ‰èƒ½æŠŠæ¶ˆæ¯å‘é€ç»™å…·ä½“çš„å®¢æˆ·ç«¯ã€‚æ¡ˆä¾‹å¦‚ä¸‹

åœ¨å‰é¢çš„æ‹¦æˆªå™¨é‡Œé¢æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°`CustomerWebSocketHandler`æ¥å£æ¥ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆåœ¨å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶ä¿å­˜å®¢æˆ·ç«¯çš„idï¼Œåœ¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ç§»é™¤idå³å¯

æ¡ˆä¾‹é‡‡ç”¨ConcurrentHashMapä¿å­˜ç”¨æˆ·çš„å›è¯idï¼Œå’Œtokenå¯¹åº”èµ·æ¥ï¼ŒçœŸå®å¼€å‘å¯ä»¥è§£æç”¨æˆ·çš„tokenä¿å­˜ç”¨æˆ·çš„useridï¼›

```java
@Slf4j
public class OnlineUserManage {

    private static final Map<String, String> WEB_SOCKET_SESSION_MAP = new ConcurrentHashMap<>();

    private OnlineUserManage() {
    }

    public static Collection<String> getAll() {
        return WEB_SOCKET_SESSION_MAP.values();
    }

    public static synchronized void add(String username, String sessionId) {
        WEB_SOCKET_SESSION_MAP.computeIfAbsent(username, k -> sessionId);
    }

    public static String remove(String username) {
        String sessionId = WEB_SOCKET_SESSION_MAP.get(username);
        WEB_SOCKET_SESSION_MAP.remove(username);
        return sessionId;
    }

    public static synchronized void removeAllSessionId(String sessionId) {
        Collection<String> col = WEB_SOCKET_SESSION_MAP.values();
        while (col.contains(sessionId)) {
            col.remove(sessionId);
        }
    }

    public static String get(String username) {
        return WEB_SOCKET_SESSION_MAP.get(username);
    }

    public static boolean isOnline(String username) {
        return WEB_SOCKET_SESSION_MAP.containsKey(username);
    }

    public static String getKey(String value) {
        Set<Map.Entry<String, String>> entries = WEB_SOCKET_SESSION_MAP.entrySet();
        for (Map.Entry<String, String> entry : entries) {
            if (entry.getValue().equals(value)) {
                return entry.getKey();
            }
        }
        return null;
    }

    public static <T> boolean sendMessages(String address, String username, T data) {
        String sessionId = WEB_SOCKET_SESSION_MAP.get(username);
        if (!StringUtils.isEmpty(sessionId)) {
            return SocketSessionManager.sendMessages(sessionId, SocketResult.build(data, address));
        }
        return false;
    }
}
```

æ‹¦æˆªå™¨æ·»åŠ å’Œåˆ é™¤å®¢æˆ·ç«¯çš„å›è¯id

```java
@Slf4j
@Component
public class WebSocketMsgHandler implements CustomerWebSocketHandler {

    @Override
    public void afterConnectionEstablished(WebSocketSession webSocketSession) {
        log.info("------------è¿æ¥æˆåŠŸ:{}-------------", webSocketSession.getId());
        String token = webSocketSession.getHandshakeHeaders().getFirst(TokenValidIntercept.TOKEN_HEAD);
        OnlineUserManage.add(token, webSocketSession.getId());
    }

    @Override
    public void handleMessage(WebSocketSession webSocketSession, TextMessage textMessage) {
        log.info("------------æ”¶åˆ°æ¶ˆæ¯:{}-------------", webSocketSession.getId());
        log.info(textMessage.getPayload());
    }

    @Override
    public void afterConnectionClosed(WebSocketSession webSocketSession, CloseStatus closeStatus) {
        log.info("------------è¿æ¥å…³é—­{}-------------", webSocketSession.getId());
        // ç§»é™¤ä¿å­˜çš„å®¢æˆ·ç«¯id
        OnlineUserManage.removeAllSessionId(webSocketSession.getId());
    }
}
```

å®šæ—¶ä»»åŠ¡æµ‹è¯•ä¸»åŠ¨ä¸‹å‘æ¶ˆæ¯

```java
@Component
@Slf4j
public class TestActiveMsgJob {

    @Scheduled(cron = "*/30 * * * * ?")
    public void test() {
        log.info("*************å®šæ—¶ä»»åŠ¡æ‰§è¡Œ**************");
        Collection<String> collection = OnlineUserManage.getAll();
        for (String id : collection) {
            SocketResult socketResult = SocketResult.build("/test/sendText");
            socketResult.setType(SocketResponseType.INITIATIVE.getCode());
            socketResult.setBody("å®šæ—¶æ¶ˆæ¯ï¼š"+UUID.randomUUID());
            SocketSessionManager.sendMessages(id, socketResult);
        }
    }
}
```
